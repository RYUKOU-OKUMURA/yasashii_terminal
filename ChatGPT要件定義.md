2026-01-20
🧩
日本語ターミナルエディタ：要件定義・アーキテクチャ・技術スタック

```md
# プロダクト名（仮）
JP-Term Editor（非エンジニア向け日本語ターミナル＋複数行エディタ）

---

## 0. 背景・目的
### 背景
- Claude Code / Codex などのCLI型生成AIを使うとき、端末の入力が「Enter=実行」になりやすく、複数行編集がしづらい。
- 非エンジニアにも扱えるよう、コマンド体系を日本語中心にしたい。

### 目的
- 端末上で「普通のEnterで改行できる」編集体験を提供しつつ、任意タイミングでAI CLIへ送信できるようにする。
- 日本語コマンド（＋揺れ吸収）で操作できる「日本語ターミナル」を提供する。

### 非目的（スコープ外）
- CLI生成AI自体の実装・課金・認証管理（既存CLIの仕組みに委ねる）
- フルIDE（LSP/デバッガ/プロジェクト管理）の網羅
- OSやシェルの完全代替

---

## 1. 想定ユーザー
- 非エンジニア（文章・指示を作るのが中心、コマンドに慣れていない）
- エンジニア（AI CLIを多用、複数行プロンプト編集を高速化したい）

---

## 2. UX方針（最重要）
### 入力と実行の衝突を避ける
- 編集エリアは **Enter=改行固定**
- 送信（実行）は別操作：
  - 推奨：Ctrl+Enter = AIへ送信
  - 代替：Escでコマンドモード → 「おくる」実行
- これにより「書く」と「走らせる」を混同しない

### 画面レイアウト（TUI）
- 上：ログビュー（AI出力 / コマンド実行結果）
- 中：エディタ（複数行、選択・コピー・貼り付け）
- 下：日本語コマンドライン（候補表示、履歴、ヘルプ）

---

## 3. 機能要件（Functional Requirements）

### 3.1 入力（Editor）
- 複数行編集（Enter改行）
- 基本編集：カーソル移動、選択、コピー/貼り付け、Undo/Redo
- 入力バッファ（現在の編集内容）を保持
- スニペット（定型文）挿入（任意、Phase2でも可）

### 3.2 ログ（Log）
- AI/コマンド出力をストリーム表示（行単位で増える）
- 重要ログのピン留め（任意、Phase2）
- ログの検索（Phase2）

### 3.3 日本語コマンド（Command System）
- 日本語コマンドを受け付ける（例：ひらく／ほぞん／おくる）
- “揺れ”の正規化（例：送信/おくって/提出 → おくる）
- コマンド補完（候補一覧と説明）
- `help` / `?` も可（非エンジニア救済）

#### コマンド例（MVP）
- ひらく <path>
- ほぞん <path?>
- おくる（エディタ内容をAIへ）
- 実行 <shell command>（任意：シェル実行）
- 差分（送信前テキスト vs AI返答 などのdiff表示）
- 履歴
- 設定
- 終了

### 3.4 生成AI CLI連携（Adapters）
- 外部コマンドとして実行（例：`claude ...` / `codex ...`）
- 標準入力へプロンプトを渡す（stdin）
- 標準出力/標準エラーをストリーミングでログへ表示
- タイムアウト/中断（Ctrl+C相当）をサポート（Phase2）

### 3.5 Diff（差分）
- 入力バッファと「直前送信内容」「直前返答」などの差分を表示
- 最小要件：ユニファイドdiff（+/-）で十分
- 将来：スニペット履歴同士のdiff

### 3.6 永続化（State/Config）
- 設定ファイル（例：~/.config/jp-term/config.toml）
- 履歴（送信履歴、コマンド履歴）
- 直前セッション復元（任意、Phase2）

---

## 4. 非機能要件（Non-Functional Requirements）

### 4.1 使いやすさ
- コマンドは日本語が主、英語エイリアスも許可（逃げ道）
- 失敗時は人間向けの説明（「何が起きたか」「どうすればいいか」）

### 4.2 性能
- 起動：体感1〜2秒を目標（言語次第）
- ストリーム表示でUIが固まらない（非同期I/O）

### 4.3 可搬性
- macOSを主ターゲット（将来：Windows/Linux）
- 単体バイナリ配布が理想（Go/Rust有利）

### 4.4 セキュリティ/プライバシー
- APIキーや認証情報はアプリ内に保持しない（既存CLIへ委譲）
- 履歴の保存はユーザーがON/OFFできる
- ログ/履歴のクリア機能
- 外部コマンド実行は明示（勝手に送らない）

---

## 5. アーキテクチャ

### 5.1 全体構成（レイヤ）
[UI層]
- TUI Renderer（画面描画/入力イベント）
- Editor Component（複数行編集）
- Log View Component（ストリーム出力）

[アプリ層]
- Command Router（日本語コマンド→内部操作）
- Normalizer（揺れ吸収/エイリアス）
- Session Manager（状態管理：バッファ/履歴/設定）

[統合層]
- AI Adapter（Claude/Codexなど、各CLI呼び出し）
- Shell Runner（任意：一般コマンド実行）
- Diff Engine（差分生成）

[永続化層]
- Config Store（設定）
- History Store（履歴・セッション）

### 5.2 データフロー（代表例：AIへ送信）
1) ユーザーがエディタに文章作成（Enter改行）
2) Ctrl+Enter もしくは「おくる」実行
3) Session Manager が送信対象テキストを確定（テンプレ適用/選択範囲優先など）
4) AI Adapter が外部CLIを起動し、stdinへ流し込み
5) stdout/stderr を非同期で読み取り Logへ追記
6) 完了後、返答を「直前返答」として保持（差分/貼り付けに使う）

### 5.3 例外・失敗時
- CLIが存在しない：インストール手順への導線メッセージ
- 認証切れ：CLIのログイン手順への導線
- 実行失敗：stderrをログに表示＋要約エラー（人間向け）

---

## 6. 技術スタック（推奨案）

### A案（推奨：配布しやすい / 実用最短）
- 言語：Go
- TUI：Bubble Tea + Bubbles（textarea/loglist）+ Lip Gloss（装飾）
- プロセス実行：os/exec（Cmd）、context（timeout/cancel）
- 設定：Viper or koanf、フォーマット：TOML/YAML/JSON
- 履歴：SQLite（任意） or JSONL（軽量）
- Diff：go-difflib or similar（ユニファイドdiff生成）
- ログ：構造化ログ＋UI表示用に整形

メリット：
- 単体バイナリで配りやすい
- 端末ストリーム処理が堅い

### B案（MVP爆速：試作向け）
- 言語：Python
- TUI：Textual（推奨） or prompt_toolkit
- プロセス実行：asyncio.create_subprocess_exec
- 設定：pydantic-settings + TOML/JSON
- 履歴：SQLite or JSONL
- Diff：difflib（標準）

メリット：
- 体験検証が早い
デメリット：
- 配布がやや手間（PyInstaller等）

---

## 7. マイルストーン（段階導入）

### Phase 1（MVP：まず動く）
- TUI 3ペイン（ログ/エディタ/コマンド）
- Enter改行、Ctrl+Enter送信
- ダミーAI（固定応答）で流れを完成
- 差分（送信前 vs 返答）
- 設定ファイル（最小：キーバインド/コマンドエイリアス）

### Phase 2（実戦投入）
- Claude/Codex Adapter（外部CLI起動）
- ストリーム表示（途中経過もログへ）
- 送信履歴/検索
- 中断（Cancel）・タイムアウト
- ログのエクスポート

### Phase 3（非エンジニア最適化）
- 日本語ガイド付きヘルプ（チュートリアル）
- “やりたいこと”入力 → コマンド候補提示（簡易ナビ）
- ひらがな/漢字の揺れ吸収拡張（辞書）

---

## 8. リスクと対策
- リスク：CLI仕様差分（claude/codexの引数や挙動が変わる）
  - 対策：Adapter層で隔離、設定でコマンドテンプレを編集可能に
- リスク：ログ/履歴に機密が残る
  - 対策：保存OFF、期限付き削除、ワンショット（保存しない）モード
- リスク：TUIのキーバインド衝突
  - 対策：キーバインド表を設定化、プリセット提供

---

## 9. 成果物（リポジトリの最小構成：例）
/cmd/jpterm        (entry)
/internal/ui        (TUI)
/internal/command   (router/normalizer)
/internal/adapter   (claude/codex/shell)
/internal/diff      (diff engine)
/internal/store     (config/history)
/docs               (操作ガイド)
```

次は、この要件を前提に **「A案（Go/Bubble Tea）」で雛形リポジトリ構成＋主要ファイルのスケルトン**まで一気に出せるよ。BOSSはまず Go でいく？それとも Python で体験検証を最速にする？
