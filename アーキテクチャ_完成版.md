# やさしいターミナル（GUI版）アーキテクチャ・完成版

## 1. 全体構成
- **Electron** を基盤としたデスクトップGUIアプリ
- **Renderer**: UI/編集/ログ表示
- **Main**: コマンド解析、CLI実行、履歴/設定管理
- **Preload**: IPCブリッジ（安全なAPIのみ公開）

```
┌─────────────────────────────────────────────────────────────┐
│                     Electron Application                     │
├─────────────────────────────────────────────────────────────┤
│ Renderer Process                      Main Process           │
│ - React UI                             - Command Parser      │
│ - Editor (Monaco)                      - Runner (CLI/Shell)   │
│ - Output (xterm.js)                    - History/Settings     │
│ - Command Bar                          - Safety Guard         │
│               ▲             IPC          ▼                   │
│           Preload (contextBridge / IPC)                      │
└─────────────────────────────────────────────────────────────┘
```

## 2. コンポーネント

### 2.1 Renderer（UI）
- **Layout**: 上（ログ）/中（エディタ）/下（コマンドバー）
- **Editor**: 複数行入力、選択送信、Undo/Redo
- **Output**: CLIのストリーム出力表示
- **Command Preview**: 変換結果のプレビュー表示
- **Settings UI**: エイリアス編集、履歴設定

### 2.2 Main（アプリ中核）
- **Command Parser**
  - 日本語エイリアスの正規化
  - 自然言語パターンの解決（Phase 2）
  - 危険コマンド判定（Phase 2）
- **Runner**
  - AI CLI実行（stdin渡し、stdout/stderrをストリーム）
  - 一般コマンド実行（必要に応じてnode-pty）
- **Stores**
  - Settings Store（エイリアス/設定永続化）
  - History Store（履歴管理）

## 3. データフロー（AI CLI送信）
1) ユーザーがエディタに入力
2) Cmd+Enterで送信
3) Mainが送信内容を取得
4) Command ParserがAI CLIコマンドに変換（必要に応じて補助）
5) RunnerがAI CLIをspawnし、stdinへ送信
6) stdout/stderrをストリームでログに反映

## 4. データフロー（日本語コマンド実行）
1) コマンドバーに日本語入力
2) Parserが正規化しコマンドを生成
3) Runnerが実行
4) 出力をログに反映

## 5. IPC設計（例）
```typescript
interface IPCChannels {
  // ターミナル実行
  'terminal:execute': (command: string) => void;
  'terminal:output': (data: string) => void;
  'terminal:clear': () => void;

  // 変換/プレビュー
  'command:preview': (input: string) => string;

  // 設定
  'settings:get': () => Settings;
  'settings:set': (settings: Partial<Settings>) => void;
  'settings:get-aliases': () => AliasMap;
  'settings:set-alias': (key: string, value: string) => void;

  // 履歴
  'history:get': (limit?: number) => HistoryEntry[];
  'history:clear': () => void;
}
```

## 6. 永続化
- 設定: `electron-store` などで保存
- 履歴: JSONL or SQLite（要件と相談）
- 保存のON/OFF切替を必須にする

## 7. エラーハンドリング
- CLIが未インストール: インストール手順を表示
- 認証切れ: CLIのログイン手順を提示
- 実行失敗: stderrをログに表示し、人間向けの要約を併記

## 8. ディレクトリ構成（案）
```
app/
├── main/                    # Electronメインプロセス
│   ├── main.ts
│   ├── ipc-handlers.ts
│   ├── runner/
│   │   ├── ai-runner.ts
│   │   └── shell-runner.ts
│   ├── command-parser/
│   │   ├── index.ts
│   │   ├── alias-resolver.ts
│   │   ├── pattern-matcher.ts
│   │   └── presets/
│   │       └── ja-commands.json
│   └── stores/
│       ├── settings-store.ts
│       └── history-store.ts
│
├── preload/
│   └── preload.ts
│
├── renderer/
│   ├── App.tsx
│   ├── components/
│   │   ├── Layout/
│   │   ├── Editor/
│   │   ├── Output/
│   │   ├── CommandBar/
│   │   └── Settings/
│   ├── stores/
│   └── styles/
└── shared/
    └── types/
```
