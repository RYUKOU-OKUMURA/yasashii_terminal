# トラブルシューティング：画面が真っ暗で何も表示されない問題

## 📋 ドキュメント情報

| 項目 | 内容 |
|------|------|
| 作成日 | 2026-01-23 |
| 問題発生日 | 2026-01-23 |
| 担当エージェント | president, boss1, worker1-3 |
| ステータス | ✅ 解決済み |

---

## 1. 問題の概要

### 発生した現象
- **Electronウィンドウは起動するが、画面が真っ暗で何も表示されない**
- Vite開発サーバーは正常に動作している
- HTML/CSS/TSXファイルは正常に作成されている
- コンソールエラーが見えない（DevToolsが開かれていない）

### 影響範囲
- アプリケーションの機能確認が不可能
- 開発・デバッグが進まない
- MVPリリースの遅延リスク

---

## 2. 調査プロセス

### Phase 1: 初期調査（闇雲な修正）

#### 試みた修正（いずれも効果なし）
1. Monaco Editorのワーカーファイル読み込み問題を想定
   - vite.config.tsにmonaco-editor設定を追加
   - 結果：改善なし

2. CSP（Content Security Policy）の問題を想定
   - CSPに `worker-src`, `child-src`, `blob:` を追加
   - 結果：改善なし

3. Monaco Editorを単純なtextareaに置き換え
   - 結果：改善なし

### Phase 2: 原因究明ミーティング

#### boss1の分析
```
可能性のある原因：

1. Vite開発サーバーが起動していない
   - npm run dev:renderer（vite）が実行されていない
   - Electronがhttp://localhost:5173に接続できない

2. React 19のHMR問題
   - React 19 + Vite 6の組み合わせで既知の問題がある可能性
   - HMR（Hot Module Replacement）が動作していない

3. CSP（Content Security Policy）が厳しすぎる
   - index.htmlのCSPがViteのHMRスクリプトをブロックしている可能性

4. Electronのpreloadスクリプト問題
   - preload.tsのコンパイルエラー
   - contextBridgeでAPIが公開されていない
```

#### 各workerの調査タスク
- **worker3**: DevToolsコンソールログ確認、Viteサーバー起動状態確認
- **worker2**: Electronウィンドウ作成、preloadスクリプト読み込み確認
- **worker1**: Reactコンポーネントエラー確認

### Phase 3: 根本原因の特定

#### 実施した修正

| 修正項目 | 内容 | ファイル |
|---------|------|---------|
| 1. sandbox無効化 | `sandbox: true` → `sandbox: false` | `app/main/main.ts` |
| 2. NODE_ENV設定 | `NODE_ENV=development` を追加 | `package.json` |
| 3. CSP削除 | `<meta http-equiv="Content-Security-Policy">` を削除 | `app/renderer/index.html` |
| 4. デバッグログ追加 | main.tsxにconsole.log追加 | `app/renderer/main.tsx` |

#### 修正後の結果
- ✅ 画面が正常に表示されるようになった
- ✅ DevToolsが開かれるようになった
- ✅ Reactアプリケーションが正常にレンダリングされるようになった

---

## 3. 根本原因

### 🎯 最も可能性が高い原因：NODE_ENVが設定されていなかったこと

#### 技術的な詳細

**1. main.tsの開発モード判定が失敗していた**

```typescript
// app/main/main.ts:49-51
if (process.env.NODE_ENV === 'development') {
  mainWindow.webContents.openDevTools();
}
```

- `NODE_ENV` が設定されていない場合、`process.env.NODE_ENV` は `undefined` になる
- `'development'` との比較が失敗し、DevToolsが開かれない
- **DevToolsがないと、エラーが見えずデバッグが不可能になる**

**2. ViteのHMR（Hot Module Replacement）が正しく動作していなかった可能性**

- Viteは `NODE_ENV=development` で正しく動作するように設計されている
- NODE_ENVが設定されていないと、Viteの動作が不安定になる可能性がある
- 特にReact 19 + Vite 6の組み合わせでは、環境変数の影響を受けやすい

### 🥈 2番目に可能性が高い原因：sandboxモードの制限

#### 技術的な詳細

Electronのsandboxモードでは、以下の制限があります：

| 制限項目 | 詳細 |
|---------|------|
| Node.js APIへのアクセス | 制限される |
| モジュール読み込み | 一部のモジュールが読み込めない |
| preloadスクリプト | 機能が制限される |
| rendererプロセス | セキュリティ上の制約が多い |

Vite + React 19の組み合わせでは、sandboxモードとの互換性に問題がある可能性があります。

### 🥉 3番目に可能性が高い原因：CSP（Content Security Policy）

- 最初に設定されていたCSPが、ViteのHMRスクリプトやinlineスクリプトをブロックしていた可能性があります
- 特に `'unsafe-inline'` や `'unsafe-eval'` が不足していた可能性があります

---

## 4. 解決策

### 採用した解決策

#### 1. NODE_ENVを明示的に設定する

```json
// package.json
{
  "scripts": {
    "dev:electron": "tsc -p tsconfig.electron.json && NODE_ENV=development electron dist-electron/main/main.js --inspect"
  }
}
```

#### 2. sandboxモードを一時的に無効化する

```typescript
// app/main/main.ts
webPreferences: {
  contextIsolation: true,
  nodeIntegration: false,
  sandbox: false, // 一時的に無効化
  preload: join(__dirname, '../preload/preload.js'),
}
```

#### 3. CSPを削除（開発モード）

```html
<!-- app/renderer/index.html -->
<!-- 開発モード用CSP - 動作確認後に適切に設定してください -->
<title>やさしいターミナル</title>
```

---

## 5. 今後の対策

### 短期的対策（必須）

| 対策項目 | 内容 | 優先度 |
|---------|------|--------|
| NODE_ENVのデフォルト設定 | 全てのnpm scriptsにNODE_ENVを明示的に設定する | P0 |
| sandboxモードの検討 | セキュリティ要件とのバランスを取る | P1 |
| CSPの適切な設定 | 開発モードと本番モードでCSPを切り替える | P1 |

### 中長期的対策（推奨）

| 対策項目 | 内容 | 優先度 |
|---------|------|--------|
| sandboxモード対応 | セキュリティ要件（sandbox: true）で動作するように調整する | P1 |
| 環境変数の管理 | dotenvなどを使用して環境変数を一元管理する | P2 |
| エラーハンドリング強化 | rendererプロセスのエラーを検出して通知する仕組みを入れる | P2 |
| 開発ツールの充実 | デバッグしやすい開発環境を整備する | P2 |

---

## 6. 学んだこと

### 開発プロセスに関する学び

1. **問題が発生したら、まず原因を特定してから修正すること**
   - 闇雲に修正を試みるのは非効率
   - DevToolsなどのツールを使って原因を特定することが重要

2. **環境変数の重要性**
   - NODE_ENVなどの環境変数は、アプリケーションの動作に大きな影響を与える
   - 明示的に設定することが重要

3. **セキュリティと開発効率のバランス**
   - sandboxモードなどのセキュリティ機能は、開発効率とのトレードオフがある
   - 開発時と本番時で設定を切り替えることが必要

### 技術的な学び

1. **Electron + Vite + React の組み合わせ**
   - 環境変数の設定が重要
   - sandboxモードでは制限が多い
   - DevToolsは必須

2. **デバッグの重要性**
   - DevToolsがないと、問題の特定がほぼ不可能
   - ログを出力することで、問題の特定が容易になる

---

## 7. 参考資料

### 関連ファイル

| ファイル | 説明 |
|---------|------|
| `app/main/main.ts` | Electronメインプロセス |
| `package.json` | npm scripts設定 |
| `app/renderer/index.html` | HTMLエントリーポイント |
| `app/renderer/main.tsx` | Reactエントリーポイント |

### 関連ドキュメント

- [CLAUDE.md](./CLAUDE.md) - プロジェクト全体の指示書
- [アーキテクチャ_完成版.md](./アーキテクチャ_完成版.md) - アーキテクチャ設計
- [技術スタック_完成版.md](./技術スタック_完成版.md) - 技術スタック

### 外部参考資料

- [Electron Documentation - Process Model](https://www.electronjs.org/docs/latest/tutorial/process-model)
- [Electron Documentation - Sandbox](https://www.electronjs.org/docs/latest/tutorial/sandbox)
- [Vite Guide - Environment Variables](https://vitejs.dev/guide/env-and-mode.html)
- [React Documentation - createRoot](https://react.dev/reference/react-dom/client/createRoot)

---

## 8. 変更履歴

| 日付 | 内容 | 担当 |
|------|------|------|
| 2026-01-23 | 初版作成 | president, worker3 |
| 2026-01-23 | 根本原因の分析と対策の追加 | president |

---

*このドキュメントは、同様の問題が発生した場合の参考資料として作成されました。*
